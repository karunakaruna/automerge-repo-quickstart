<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="/automerge.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Canvas Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0f1115; color: #e5e7eb; }
    header { padding: 12px 16px; position: fixed; left: 0; right: 0; top: 0; z-index: 10; background: rgba(15,17,21,0.55); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(255,255,255,0.06); }
    main { padding: 72px 16px 16px; }
    code { background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 6px; }
    .hint { opacity: 0.8; }
    .row { margin: 6px 0; }
    a.btn { display: inline-block; padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); color: inherit; text-decoration: none; }
  </style>
  <script>
    (function(){
      const qp = new URLSearchParams(location.search);
      const server = qp.get('server') || (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;
      const docId = qp.get('docId') || '';
      window.WORLD_TREE_SERVER = server;
      if (docId) window.WORLD_TREE_DOC_ID = docId; // only set when provided
      // Reflect in UI
      window.addEventListener('DOMContentLoaded', () => {
        const s = document.getElementById('server'); if (s) s.textContent = server;
        const d = document.getElementById('doc'); if (d) d.textContent = docId || '—';
        const u = document.getElementById('url'); if (u) u.textContent = location.href;
      });
    })();
  </script>
</head>
<body>
  <header>
    <strong>Canvas Viewer</strong>
    <span class="hint"> · sync <code id="server">—</code> · doc <code id="doc">—</code></span>
    <span class="hint"> · <code id="url">—</code></span>
    <a class="btn" href="/" style="float:right">Back to App</a>
  </header>
  <main>
    <div class="row hint">This page initializes the WorldTree widget (Automerge Repo client) to the same sync server and selected docId.</div>
    <div class="row hint">Next step: embed the full Obsidian Canvas Viewer UI.</div>
  </main>

  <!-- Ensure bridge initializes before widget by importing then injecting the widget -->
  <script type="module">
    try {
      await import('/src/ocv-bridge.ts');
    } catch (e) {
      console.error('Failed to load Automerge bridge module', e);
    }
    const s = document.createElement('script');
    s.src = './build/worldtree-widget.js';
    s.setAttribute('data-minimized', 'false');
    s.setAttribute('data-follow', 'true');
    document.body.appendChild(s);
  </script>
</body>
</html>
